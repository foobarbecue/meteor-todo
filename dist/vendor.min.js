!function(t){if("function"==typeof bootstrap)bootstrap("promise",t);else if("object"==typeof exports)module.exports=t();else if("function"==typeof define&&define.amd)define(t);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=t}else Q=t()}(function(){"use strict";function t(t){return function(){return G.apply(t,arguments)}}function e(t){return t===Object(t)}function n(t){return"[object StopIteration]"===ee(t)||t instanceof M}function o(t,e){if(H&&e.stack&&"object"==typeof t&&null!==t&&t.stack&&-1===t.stack.indexOf(ne)){for(var n=[],o=e;o;o=o.source)o.stack&&n.unshift(o.stack);n.unshift(t.stack);var i=n.join("\n"+ne+"\n");t.stack=r(i)}}function r(t){for(var e=t.split("\n"),n=[],o=0;o<e.length;++o){var r=e[o];c(r)||i(r)||!r||n.push(r)}return n.join("\n")}function i(t){return-1!==t.indexOf("(module.js:")||-1!==t.indexOf("(node.js:")}function s(t){var e=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(t);if(e)return[e[1],Number(e[2])];var n=/at ([^ ]+):(\d+):(?:\d+)$/.exec(t);if(n)return[n[1],Number(n[2])];var o=/.*@(.+):(\d+)$/.exec(t);return o?[o[1],Number(o[2])]:void 0}function c(t){var e=s(t);if(!e)return!1;var n=e[0],o=e[1];return n===F&&o>=W&&se>=o}function u(){if(H)try{throw new Error}catch(t){var e=t.stack.split("\n"),n=e[0].indexOf("@")>0?e[1]:e[2],o=s(n);if(!o)return;return F=o[0],o[1]}}function a(t,e,n){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(e+" is deprecated, use "+n+" instead.",new Error("").stack),t.apply(t,arguments)}}function p(t){return m(t)?t:v(t)?O(t):S(t)}function f(){function t(t){e=t,i.source=t,z(n,function(e,n){B(function(){t.promiseDispatch.apply(t,n)})},void 0),n=void 0,o=void 0}var e,n=[],o=[],r=Y(f.prototype),i=Y(h.prototype);if(i.promiseDispatch=function(t,r,i){var s=V(arguments);n?(n.push(s),"when"===r&&i[1]&&o.push(i[1])):B(function(){e.promiseDispatch.apply(e,s)})},i.valueOf=function(){if(n)return i;var t=y(e);return m(t)&&(e=t),t},i.inspect=function(){return e?e.inspect():{state:"pending"}},p.longStackSupport&&H)try{throw new Error}catch(s){i.stack=s.stack.substring(s.stack.indexOf("\n")+1)}return r.promise=i,r.resolve=function(n){e||t(p(n))},r.fulfill=function(n){e||t(S(n))},r.reject=function(n){e||t(C(n))},r.notify=function(t){e||z(o,function(e,n){B(function(){n(t)})},void 0)},r}function d(t){if("function"!=typeof t)throw new TypeError("resolver must be a function.");var e=f();try{t(e.resolve,e.reject,e.notify)}catch(n){e.reject(n)}return e.promise}function l(t){return d(function(e,n){for(var o=0,r=t.length;r>o;o++)p(t[o]).then(e,n)})}function h(t,e,n){void 0===e&&(e=function(t){return C(new Error("Promise does not support operation: "+t))}),void 0===n&&(n=function(){return{state:"unknown"}});var o=Y(h.prototype);if(o.promiseDispatch=function(n,r,i){var s;try{s=t[r]?t[r].apply(o,i):e.call(o,r,i)}catch(c){s=C(c)}n&&n(s)},o.inspect=n,n){var r=n();"rejected"===r.state&&(o.exception=r.reason),o.valueOf=function(){var t=n();return"pending"===t.state||"rejected"===t.state?o:t.value}}return o}function _(t,e,n,o){return p(t).then(e,n,o)}function y(t){if(m(t)){var e=t.inspect();if("fulfilled"===e.state)return e.value}return t}function m(t){return e(t)&&"function"==typeof t.promiseDispatch&&"function"==typeof t.inspect}function v(t){return e(t)&&"function"==typeof t.then}function g(t){return m(t)&&"pending"===t.inspect().state}function b(t){return!m(t)||"fulfilled"===t.inspect().state}function k(t){return m(t)&&"rejected"===t.inspect().state}function w(){oe.length=0,re.length=0,ie||(ie=!0)}function j(t,e){ie&&(re.push(t),oe.push(e&&"undefined"!=typeof e.stack?e.stack:"(no stack) "+e))}function R(t){if(ie){var e=K(re,t);-1!==e&&(re.splice(e,1),oe.splice(e,1))}}function C(t){var e=h({when:function(e){return e&&R(this),e?e(t):this}},function(){return this},function(){return{state:"rejected",reason:t}});return j(e,t),e}function S(t){return h({when:function(){return t},get:function(e){return t[e]},set:function(e,n){t[e]=n},"delete":function(e){delete t[e]},post:function(e,n){return null===e||void 0===e?t.apply(void 0,n):t[e].apply(t,n)},apply:function(e,n){return t.apply(e,n)},keys:function(){return te(t)}},void 0,function(){return{state:"fulfilled",value:t}})}function O(t){var e=f();return B(function(){try{t.then(e.resolve,e.reject,e.notify)}catch(n){e.reject(n)}}),e.promise}function I(t){return h({isDef:function(){}},function(e,n){return L(t,e,n)},function(){return p(t).inspect()})}function T(t,e,n){return p(t).spread(e,n)}function x(t){return function(){function e(t,e){var s;if("undefined"==typeof StopIteration){try{s=o[t](e)}catch(c){return C(c)}return s.done?s.value:_(s.value,r,i)}try{s=o[t](e)}catch(c){return n(c)?c.value:C(c)}return _(s,r,i)}var o=t.apply(this,arguments),r=e.bind(e,"next"),i=e.bind(e,"throw");return r()}}function E(t){p.done(p.async(t)())}function N(t){throw new M(t)}function A(t){return function(){return T([this,U(arguments)],function(e,n){return t.apply(e,n)})}}function L(t,e,n){return p(t).dispatch(e,n)}function U(t){return _(t,function(t){var e=0,n=f();return z(t,function(o,r,i){var s;m(r)&&"fulfilled"===(s=r.inspect()).state?t[i]=s.value:(++e,_(r,function(o){t[i]=o,0===--e&&n.resolve(t)},n.reject,function(t){n.notify({index:i,value:t})}))},void 0),0===e&&n.resolve(t),n.promise})}function D(t){return _(t,function(t){return t=X(t,p),_(U(X(t,function(t){return _(t,$,$)})),function(){return t})})}function Q(t){return p(t).allSettled()}function J(t,e){return p(t).then(void 0,void 0,e)}function P(t,e){return p(t).nodeify(e)}var H=!1;try{throw new Error}catch(q){H=!!q.stack}var F,M,W=u(),$=function(){},B=function(){function t(){for(;e.next;){e=e.next;var n=e.task;e.task=void 0;var r=e.domain;r&&(e.domain=void 0,r.enter());try{n()}catch(s){if(i)throw r&&r.exit(),setTimeout(t,0),r&&r.enter(),s;setTimeout(function(){throw s},0)}r&&r.exit()}o=!1}var e={task:void 0,next:null},n=e,o=!1,r=void 0,i=!1;if(B=function(t){n=n.next={task:t,domain:i&&process.domain,next:null},o||(o=!0,r())},"undefined"!=typeof process&&process.nextTick)i=!0,r=function(){process.nextTick(t)};else if("function"==typeof setImmediate)r="undefined"!=typeof window?setImmediate.bind(window,t):function(){setImmediate(t)};else if("undefined"!=typeof MessageChannel){var s=new MessageChannel;s.port1.onmessage=function(){r=c,s.port1.onmessage=t,t()};var c=function(){s.port2.postMessage(0)};r=function(){setTimeout(t,0),c()}}else r=function(){setTimeout(t,0)};return B}(),G=Function.call,V=t(Array.prototype.slice),z=t(Array.prototype.reduce||function(t,e){var n=0,o=this.length;if(1===arguments.length)for(;;){if(n in this){e=this[n++];break}if(++n>=o)throw new TypeError}for(;o>n;n++)n in this&&(e=t(e,this[n],n));return e}),K=t(Array.prototype.indexOf||function(t){for(var e=0;e<this.length;e++)if(this[e]===t)return e;return-1}),X=t(Array.prototype.map||function(t,e){var n=this,o=[];return z(n,function(r,i,s){o.push(t.call(e,i,s,n))},void 0),o}),Y=Object.create||function(t){function e(){}return e.prototype=t,new e},Z=t(Object.prototype.hasOwnProperty),te=Object.keys||function(t){var e=[];for(var n in t)Z(t,n)&&e.push(n);return e},ee=t(Object.prototype.toString);M="undefined"!=typeof ReturnValue?ReturnValue:function(t){this.value=t};var ne="From previous event:";p.resolve=p,p.nextTick=B,p.longStackSupport=!1,p.defer=f,f.prototype.makeNodeResolver=function(){var t=this;return function(e,n){e?t.reject(e):t.resolve(arguments.length>2?V(arguments,1):n)}},p.Promise=d,p.promise=d,d.race=l,d.all=U,d.reject=C,d.resolve=p,p.passByCopy=function(t){return t},h.prototype.passByCopy=function(){return this},p.join=function(t,e){return p(t).join(e)},h.prototype.join=function(t){return p([this,t]).spread(function(t,e){if(t===e)return t;throw new Error("Can't join: not the same: "+t+" "+e)})},p.race=l,h.prototype.race=function(){return this.then(p.race)},p.makePromise=h,h.prototype.toString=function(){return"[object Promise]"},h.prototype.then=function(t,e,n){function r(e){try{return"function"==typeof t?t(e):e}catch(n){return C(n)}}function i(t){if("function"==typeof e){o(t,c);try{return e(t)}catch(n){return C(n)}}return C(t)}function s(t){return"function"==typeof n?n(t):t}var c=this,u=f(),a=!1;return B(function(){c.promiseDispatch(function(t){a||(a=!0,u.resolve(r(t)))},"when",[function(t){a||(a=!0,u.resolve(i(t)))}])}),c.promiseDispatch(void 0,"when",[void 0,function(t){var e,n=!1;try{e=s(t)}catch(o){if(n=!0,!p.onerror)throw o;p.onerror(o)}n||u.notify(e)}]),u.promise},p.when=_,h.prototype.thenResolve=function(t){return this.then(function(){return t})},p.thenResolve=function(t,e){return p(t).thenResolve(e)},h.prototype.thenReject=function(t){return this.then(function(){throw t})},p.thenReject=function(t,e){return p(t).thenReject(e)},p.nearer=y,p.isPromise=m,p.isPromiseAlike=v,p.isPending=g,h.prototype.isPending=function(){return"pending"===this.inspect().state},p.isFulfilled=b,h.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},p.isRejected=k,h.prototype.isRejected=function(){return"rejected"===this.inspect().state};var oe=[],re=[],ie=!0;p.resetUnhandledRejections=w,p.getUnhandledReasons=function(){return oe.slice()},p.stopUnhandledRejectionTracking=function(){w(),ie=!1},w(),p.reject=C,p.fulfill=S,p.master=I,p.spread=T,h.prototype.spread=function(t,e){return this.all().then(function(e){return t.apply(void 0,e)},e)},p.async=x,p.spawn=E,p["return"]=N,p.promised=A,p.dispatch=L,h.prototype.dispatch=function(t,e){var n=this,o=f();return B(function(){n.promiseDispatch(o.resolve,t,e)}),o.promise},p.get=function(t,e){return p(t).dispatch("get",[e])},h.prototype.get=function(t){return this.dispatch("get",[t])},p.set=function(t,e,n){return p(t).dispatch("set",[e,n])},h.prototype.set=function(t,e){return this.dispatch("set",[t,e])},p.del=p["delete"]=function(t,e){return p(t).dispatch("delete",[e])},h.prototype.del=h.prototype["delete"]=function(t){return this.dispatch("delete",[t])},p.mapply=p.post=function(t,e,n){return p(t).dispatch("post",[e,n])},h.prototype.mapply=h.prototype.post=function(t,e){return this.dispatch("post",[t,e])},p.send=p.mcall=p.invoke=function(t,e){return p(t).dispatch("post",[e,V(arguments,2)])},h.prototype.send=h.prototype.mcall=h.prototype.invoke=function(t){return this.dispatch("post",[t,V(arguments,1)])},p.fapply=function(t,e){return p(t).dispatch("apply",[void 0,e])},h.prototype.fapply=function(t){return this.dispatch("apply",[void 0,t])},p["try"]=p.fcall=function(t){return p(t).dispatch("apply",[void 0,V(arguments,1)])},h.prototype.fcall=function(){return this.dispatch("apply",[void 0,V(arguments)])},p.fbind=function(t){var e=p(t),n=V(arguments,1);return function(){return e.dispatch("apply",[this,n.concat(V(arguments))])}},h.prototype.fbind=function(){var t=this,e=V(arguments);return function(){return t.dispatch("apply",[this,e.concat(V(arguments))])}},p.keys=function(t){return p(t).dispatch("keys",[])},h.prototype.keys=function(){return this.dispatch("keys",[])},p.all=U,h.prototype.all=function(){return U(this)},p.allResolved=a(D,"allResolved","allSettled"),h.prototype.allResolved=function(){return D(this)},p.allSettled=Q,h.prototype.allSettled=function(){return this.then(function(t){return U(X(t,function(t){function e(){return t.inspect()}return t=p(t),t.then(e,e)}))})},p.fail=p["catch"]=function(t,e){return p(t).then(void 0,e)},h.prototype.fail=h.prototype["catch"]=function(t){return this.then(void 0,t)},p.progress=J,h.prototype.progress=function(t){return this.then(void 0,void 0,t)},p.fin=p["finally"]=function(t,e){return p(t)["finally"](e)},h.prototype.fin=h.prototype["finally"]=function(t){return t=p(t),this.then(function(e){return t.fcall().then(function(){return e})},function(e){return t.fcall().then(function(){throw e})})},p.done=function(t,e,n,o){return p(t).done(e,n,o)},h.prototype.done=function(t,e,n){var r=function(t){B(function(){if(o(t,i),!p.onerror)throw t;p.onerror(t)})},i=t||e||n?this.then(t,e,n):this;"object"==typeof process&&process&&process.domain&&(r=process.domain.bind(r)),i.then(void 0,r)},p.timeout=function(t,e,n){return p(t).timeout(e,n)},h.prototype.timeout=function(t,e){var n=f(),o=setTimeout(function(){n.reject(new Error(e||"Timed out after "+t+" ms"))},t);return this.then(function(t){clearTimeout(o),n.resolve(t)},function(t){clearTimeout(o),n.reject(t)},n.notify),n.promise},p.delay=function(t,e){return void 0===e&&(e=t,t=void 0),p(t).delay(e)},h.prototype.delay=function(t){return this.then(function(e){var n=f();return setTimeout(function(){n.resolve(e)},t),n.promise})},p.nfapply=function(t,e){return p(t).nfapply(e)},h.prototype.nfapply=function(t){var e=f(),n=V(t);return n.push(e.makeNodeResolver()),this.fapply(n).fail(e.reject),e.promise},p.nfcall=function(t){var e=V(arguments,1);return p(t).nfapply(e)},h.prototype.nfcall=function(){var t=V(arguments),e=f();return t.push(e.makeNodeResolver()),this.fapply(t).fail(e.reject),e.promise},p.nfbind=p.denodeify=function(t){var e=V(arguments,1);return function(){var n=e.concat(V(arguments)),o=f();return n.push(o.makeNodeResolver()),p(t).fapply(n).fail(o.reject),o.promise}},h.prototype.nfbind=h.prototype.denodeify=function(){var t=V(arguments);return t.unshift(this),p.denodeify.apply(void 0,t)},p.nbind=function(t,e){var n=V(arguments,2);return function(){function o(){return t.apply(e,arguments)}var r=n.concat(V(arguments)),i=f();return r.push(i.makeNodeResolver()),p(o).fapply(r).fail(i.reject),i.promise}},h.prototype.nbind=function(){var t=V(arguments,0);return t.unshift(this),p.nbind.apply(void 0,t)},p.nmapply=p.npost=function(t,e,n){return p(t).npost(e,n)},h.prototype.nmapply=h.prototype.npost=function(t,e){var n=V(e||[]),o=f();return n.push(o.makeNodeResolver()),this.dispatch("post",[t,n]).fail(o.reject),o.promise},p.nsend=p.nmcall=p.ninvoke=function(t,e){var n=V(arguments,2),o=f();return n.push(o.makeNodeResolver()),p(t).dispatch("post",[e,n]).fail(o.reject),o.promise},h.prototype.nsend=h.prototype.nmcall=h.prototype.ninvoke=function(t){var e=V(arguments,1),n=f();return e.push(n.makeNodeResolver()),this.dispatch("post",[t,e]).fail(n.reject),n.promise},p.nodeify=P,h.prototype.nodeify=function(t){return t?void this.then(function(e){B(function(){t(null,e)})},function(e){B(function(){t(e)})}):this};var se=u();return p}),function(t,e){"function"==typeof define&&define.amd?define(e):"object"==typeof exports?module.exports=e():t.DDP=e()}(this,function(){"use strict";var t=function(){var t=0;return function(){return(t++).toString()}}(),e='{"server_id":"0"}',n=10,o=500,r=["added","changed","connected","error","failed","nosub","ready","removed","result","updated","ping"],i=function(t){this._endpoint=t.endpoint,this._SocketConstructor=t.SocketConstructor,this._autoreconnect=!t.do_not_autoreconnect,this._debug=t.debug,this._onReadyCallbacks={},this._onStopCallbacks={},this._onErrorCallbacks={},this._onResultCallbacks={},this._onUpdatedCallbacks={},this._events={},this._queue=[],this.readyState=-1,this._reconnect_count=0,this._reconnect_incremental_timer=0,t.do_not_autoconnect||this.connect()};return i.prototype.constructor=i,i.prototype.connect=function(){this.readyState=0,this._socket=new this._SocketConstructor(this._endpoint),this._socket.onopen=this._on_socket_open.bind(this),this._socket.onmessage=this._on_socket_message.bind(this),this._socket.onerror=this._on_socket_error.bind(this),this._socket.onclose=this._on_socket_close.bind(this)},i.prototype.method=function(e,n,o,r){var i=t();return this._onResultCallbacks[i]=o,this._onUpdatedCallbacks[i]=r,this._send({msg:"method",id:i,method:e,params:n}),i},i.prototype.sub=function(e,n,o,r,i){var s=t();return this._onReadyCallbacks[s]=o,this._onStopCallbacks[s]=r,this._onErrorCallbacks[s]=i,this._send({msg:"sub",id:s,name:e,params:n}),s},i.prototype.unsub=function(t){this._send({msg:"unsub",id:t})},i.prototype.on=function(t,e){this._events[t]=this._events[t]||[],this._events[t].push(e)},i.prototype.off=function(t,e){this._events[t]&&this._events[t].splice(this._events[t].indexOf(e),1)},i.prototype._emit=function(t){if(this._events[t]){var e=arguments,n=this;this._events[t].forEach(function(t){t.apply(n,Array.prototype.slice.call(e,1))})}},i.prototype._send=function(t){if(1!==this.readyState&&"connect"!==t.msg)return void this._queue.push(t);var e;e="undefined"==typeof EJSON?JSON.stringify(t):EJSON.stringify(t),this._socket.send(e)},i.prototype._try_reconnect=function(){this._reconnect_count<n&&setTimeout(this.connect.bind(this),this._reconnect_incremental_timer),this._reconnect_count+=1,this._reconnect_incremental_timer+=o*this._reconnect_count},i.prototype._on_result=function(t){if(this._onResultCallbacks[t.id])this._onResultCallbacks[t.id](t.error,t.result),delete this._onResultCallbacks[t.id],t.error&&delete this._onUpdatedCallbacks[t.id];else if(t.error)throw delete this._onUpdatedCallbacks[t.id],t.error},i.prototype._on_updated=function(t){var e=this;t.methods.forEach(function(t){e._onUpdatedCallbacks[t]&&(e._onUpdatedCallbacks[t](),delete e._onUpdatedCallbacks[t])})},i.prototype._on_nosub=function(t){if(t.error){if(!this._onErrorCallbacks[t.id])throw delete this._onReadyCallbacks[t.id],delete this._onStopCallbacks[t.id],new Error(t.error);return this._onErrorCallbacks[t.id](t.error),delete this._onReadyCallbacks[t.id],delete this._onStopCallbacks[t.id],void delete this._onErrorCallbacks[t.id]}this._onStopCallbacks[t.id]&&this._onStopCallbacks[t.id](),delete this._onReadyCallbacks[t.id],delete this._onStopCallbacks[t.id],delete this._onErrorCallbacks[t.id]},i.prototype._on_ready=function(t){var e=this;t.subs.forEach(function(t){e._onReadyCallbacks[t]&&(e._onReadyCallbacks[t](),delete e._onReadyCallbacks[t])})},i.prototype._on_error=function(t){this._emit("error",t)},i.prototype._on_connected=function(t){var e=0===this._reconnect_count,n=e?"connected":"reconnected";this.readyState=1,this._reconnect_count=0,this._reconnect_incremental_timer=0;for(var o=this._queue.length,r=0;o>r;r++)this._send(this._queue.shift());this._emit(n,t)},i.prototype._on_failed=function(t){this.readyState=4,this._emit("failed",t)},i.prototype._on_added=function(t){this._emit("added",t)},i.prototype._on_removed=function(t){this._emit("removed",t)},i.prototype._on_changed=function(t){this._emit("changed",t)},i.prototype._on_ping=function(t){this._send({msg:"pong",id:t.id})},i.prototype._on_socket_close=function(){this.readyState=4,this._emit("socket_close"),this._autoreconnect&&this._try_reconnect()},i.prototype._on_socket_error=function(t){this.readyState=4,this._emit("socket_error",t)},i.prototype._on_socket_open=function(){this._send({msg:"connect",version:"pre1",support:["pre1"]})},i.prototype._on_socket_message=function(t){var n;if(this._debug&&console.log(t),t.data!==e){try{if(n="undefined"==typeof EJSON?JSON.parse(t.data):EJSON.parse(t.data),-1===r.indexOf(n.msg))throw new Error}catch(o){return console.warn("Non DDP message received:"),void console.warn(t.data)}this["_on_"+n.msg](n)}},i}),function(t,e){"function"==typeof define&&define.amd?define(e):"object"==typeof exports?module.exports=e():t.Asteroid=e()}(this,function(){"use strict";function t(t){if("undefined"!=typeof EJSON)return EJSON.clone(t);var e=typeof t;switch(e){case"undefined":case"function":return void 0;case"string":case"number":case"boolean":return t;case"object":return null===t?null:JSON.parse(JSON.stringify(t));default:return}}function e(t){var e="";for(var n in t)e+=n+"="+t[n]+"&";return e=e.slice(0,-1)}function n(){for(var t="",e=0;8>e;e++)t+=Math.floor(65536*(1+Math.random())).toString(16).substring(1);return t}function o(t,e){var n=JSON.stringify(t),o=JSON.stringify(e);return n===o}var r=function(){};r.prototype={constructor:r,_events:{},on:function(t,e){this._events[t]=this._events[t]||[],this._events[t].push(e)},off:function(t,e){this._events[t]&&this._events[t].splice(this._events[t].indexOf(e),1)},_emit:function(t){if(this._events[t]){var e=arguments,n=this;this._events[t].forEach(function(t){t.apply(n,Array.prototype.slice.call(e,1))})}}};var i=function(t){this._host=t.host,this._ddpOptions=t.ddpOptions,this._ddpOptions.do_not_autoconnect=!0,this._do_not_autocreate_collections=t._do_not_autocreate_collections,this.collections={},this.subscriptions={},this._init()};i.prototype=new r,i.prototype.constructor=i,i.prototype._init=function(){var t=this;t.ddp=new DDP(this._ddpOptions),t.ddp.on("connected",function(){t._tryResumeLogin(),t.ddp.sub("meteor.loginServiceConfiguration"),t._emit("connected")}),t.ddp.on("added",function(e){t._onAdded(e)}),t.ddp.on("changed",function(e){t._onChanged(e)}),t.ddp.on("removed",function(e){t._onRemoved(e)}),t.ddp.connect()},i.prototype._onAdded=function(t){var e=["meteor_accounts_loginServiceConfiguration","users"],n=t.collection;if(!this.collections[n]){if(this._do_not_autocreate_collections&&-1===e.indexOf(n))return;this.createCollection(n)}var o=t.fields||{};o._id=t.id,this.collections[n]._remoteToLocalInsert(o)},i.prototype._onRemoved=function(t){this.collections[t.collection]&&this.collections[t.collection]._remoteToLocalRemove(t.id)},i.prototype._onChanged=function(t){this.collections[t.collection]&&(t.fields||(t.fields={}),t.cleared&&t.cleared.forEach(function(e){t.fields[e]=void 0}),this.collections[t.collection]._remoteToLocalUpdate(t.id,t.fields))},i.prototype.subscribe=function(t){if(this.subscriptions[t])return this.subscriptions[t];var e=Q.defer();this.subscriptions[t]=e.promise;var n=Array.prototype.slice.call(arguments,1);return this.ddp.sub(t,n,function(t,n){t?e.reject(t,n):e.resolve(n)}),this.subscriptions[t]},i.prototype.unsubscribe=function(t){this.ddp.unsub(t)},i.prototype.call=function(t){var e=Array.prototype.slice.call(arguments,1);return this.apply(t,e)},i.prototype.apply=function(t,e){var n=Q.defer(),o=Q.defer(),r=function(t,e){t?(n.reject(t),o.reject()):n.resolve(e)},i=function(){o.resolve()};return this.ddp.method(t,e,r,i),{result:n.promise,updated:o.promise}},i.prototype.createCollection=function(t){return this.collections[t]||(this.collections[t]=new a(t,this,p)),this.collections[t]};var s="__del__",c="__upd__",u=function(t){var e=s.length,n=c.length,o=t.slice(-1*e),r=t.slice(-1*n);return o===s||r===c},a=function(t,e,n){this.name=t,this.asteroid=e,this.db=new n};a.prototype=new r,a.prototype.constructor=a,a.prototype._localToLocalInsert=function(t){var e=this.db.get(t._id);if(e)throw new Error("Item exists");this.db.set(t._id,t),this._emit("insert",t._id)},a.prototype._remoteToLocalInsert=function(t){var e=this.db.get(t._id);o(e,t)||(this.db.set(t._id,t),this._emit("insert",t._id))},a.prototype._restoreInserted=function(t){this.db.del(t),this._emit("restore",t)},a.prototype._localToRemoteInsert=function(t){var e=this,n=Q.defer(),o="/"+e.name+"/insert";return this.asteroid.ddp.method(o,[t],function(o,r){o?(e._restoreInserted(t._id),n.reject(o)):n.resolve(r)}),n.promise},a.prototype.insert=function(t){return t._id||(t._id=n()),this._localToLocalInsert(t,!1),this._localToRemoteInsert(t)},a.prototype._localToLocalRemove=function(t){var e=this.db.get(t);return e?(this.db.set(t+s,e),this.db.del(t),void this._emit("remove",t)):void console.warn("Item not present.")},a.prototype._remoteToLocalRemove=function(t){var e=this.db.get(t);e||(e=this.db.get(t+s),e?this.db.del(t+s):console.warn("Item not present.")),this.db.del(t),this.db.del(t+s),this._emit("remove",t)},a.prototype._restoreRemoved=function(t){var e=this.db.get(t+s);this.db.set(t,e),this.db.del(t+s),this._emit("restore",t)},a.prototype._localToRemoteRemove=function(t){var e=this,n=Q.defer(),o="/"+e.name+"/remove";return this.asteroid.ddp.method(o,[{_id:t}],function(o,r){o?(e._restoreRemoved(t),n.reject(o)):n.resolve(r)}),n.promise},a.prototype.remove=function(t){return this._localToLocalRemove(t),this._localToRemoteRemove(t)},a.prototype._localToLocalUpdate=function(t,e){var n=this.db.get(t);if(!n)throw new Error("Item not present");this.db.set(t+c,n),this.db.set(t,e),this._emit("update",t)},a.prototype._remoteToLocalUpdate=function(t,e){var n=this.db.get(t);if(!n)return void console.warn("Item not present");for(var o in e)n[o]=e[o];this.db.set(t,n),this.db.del(t+c),this._emit("update",t)},a.prototype._restoreUpdated=function(t){var e=this.db.get(t+c);this.db.set(t,e),this.db.del(t+c),this._emit("restore",t)},a.prototype._localToRemoteUpdate=function(t,e){var n=this,o=Q.defer(),r="/"+n.name+"/update",i={_id:t},s={$set:e};return this.asteroid.ddp.method(r,[i,s],function(e,r){e?(n._restoreUpdated(t),o.reject(e)):o.resolve(r)}),o.promise},a.prototype.update=function(t,e){return this._localToLocalUpdate(t,e),this._localToRemoteUpdate(t,e)},a.prototype.find=function(t){return this.db.find(t)},a.prototype.findOne=function(t){return this.db.findOne(t)};var p=function(){this.itemsHash={},this.itemsArray=[]};return p.prototype.constructor=p,p.prototype.set=function(e,n){if(n=t(n),this.itemsHash[e]){var o=this.itemsArray.indexOf(this.itemsHash[e]);this.itemsArray[o]=n}else this.itemsArray.push(n);this.itemsHash[e]=n},p.prototype.get=function(e){return t(this.itemsHash[e])},p.prototype.find=function(e){var n=function(t,e){return e.split(".").reduce(function(t,e){return t=t[e]},t)},o=Object.keys(e),r=[];return this.itemsArray.forEach(function(i){for(var s=0;s<o.length;s++){var c=n(i,o[s]);if(c!==e[o[s]])return}u(i._id)||r.push(t(i))}),r},p.prototype.findOne=function(t){return this.find(t)[0]},p.prototype.del=function(t){if(this.itemsHash[t]){var e=this.itemsArray.indexOf(this.itemsHash[t]);this.itemsArray.splice(e,1),delete this.itemsHash[t]}},p.prototype.ls=function(){return t(this.itemsArray)},i.DumbDb=p,i.prototype._getOauthClientId=function(t){var e="meteor_accounts_loginServiceConfiguration",n=this.collections[e].db.itemsArray,o="";return n.forEach(function(e){e.service===t&&("facebook"===t&&(o=e.appId),"google"===t&&(o=e.clientId),"github"===t&&(o=e.clientId),"twitter"===t&&(o=e.consumerKey))}),o},i.prototype._initOauthLogin=function(t,e,n){var o=this;return Q().then(function(){var t=Q.defer(),e=window.open(n,"Login");e.focus&&e.focus();var o=setInterval(function(){(e.closed||void 0===e.closed)&&(clearInterval(o),t.resolve())},100);return t.promise}).then(function(){var t=Q.defer(),n={oauth:{credentialToken:e}};return o.ddp.method("login",[n],function(e,n){e?(delete o.userId,delete o.loggedIn,delete localStorage[o._host+"__login_token__"],t.reject(e),o._emit("loginError",e)):(o.userId=n.id,o.loggedIn=!0,localStorage[o._host+"__login_token__"]=n.token,o._emit("login",n),t.resolve(n.id))}),t.promise})},i.prototype._tryResumeLogin=function(){var t=this,e=localStorage[t._host+"__login_token__"];return e?Q().then(function(){var n=Q.defer(),o={resume:e};return t.ddp.method("login",[o],function(e,o){e?(delete t.userId,delete t.loggedIn,delete localStorage[t._host+"__login_token__"],t._emit("loginError",e),n.reject(e)):(t.userId=o.id,t.loggedIn=!0,localStorage[t._host+"__login_token__"]=o.token,t._emit("login",o),n.resolve(o.id))}),n.promise}):void 0},i.prototype.loginWithFacebook=function(t){var o=n(),r={client_id:this._getOauthClientId("facebook"),redirect_uri:this._host+"/_oauth/facebook?close",state:o,scope:t||"email"},i="https://www.facebook.com/dialog/oauth?"+e(r);return this._initOauthLogin("facebook",o,i)},i.prototype.loginWithGoogle=function(t){var o=n(),r={response_type:"code",client_id:this._getOauthClientId("google"),redirect_uri:this._host+"/_oauth/google?close",state:o,scope:t||"openid email"},i="https://accounts.google.com/o/oauth2/auth?"+e(r);return this._initOauthLogin("google",o,i)},i.prototype.loginWithGithub=function(t){var o=n(),r={client_id:this._getOauthClientId("github"),redirect_uri:this._host+"/_oauth/github?close",state:o,scope:t||"email"},i="https://github.com/login/oauth/authorize?"+e(r);return this._initOauthLogin("github",o,i)},i.prototype.loginWithTwitter=function(){var t=n(),o=this._host+"/_oauth/twitter?close&state="+t,r={requestTokenAndRedirect:encodeURIComponent(o),state:t},i=this._host+"/_oauth/twitter/?"+e(r);return this._initOauthLogin("twitter",t,i)},i.prototype.logout=function(){var t=this,e=Q.defer();return t.ddp.method("logout",[],function(n,o){n?(t._emit("logoutError",n),e.reject(n)):(delete t.userId,delete t.loggedIn,delete localStorage[t._host+"__login_token__"],t._emit("logout",o),e.resolve(o))}),e.promise},i});